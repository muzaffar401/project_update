<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    #back-button {
        display: none;
    }
</style>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Admin Panel</h1>
        <div id="user-data-list" class="mt-3"></div>
        <div id="donation-records" class="mt-3">
            <button id="back-button" class="btn btn-primary mb-3">Back</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            console.log('Users from local storage:', users);  // Debugging line

            // Display User Data
            const userDataList = document.getElementById('user-data-list');
            const donationRecords = document.getElementById('donation-records');
            const backButton = document.getElementById('back-button');

            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.classList.add('card', 'mb-3');
                userCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">Username: ${user.username}</h5>
                        <p class="card-text"><strong>Email:</strong> ${user.email}</p>
                        <p class="card-text"><strong>Phone:</strong> ${user.phone}</p>
                        <button class="btn btn-primary btn-sm donate-btn" data-user="${user.username}">View Donations</button>
                    </div>
                `;
                userDataList.appendChild(userCard);
            });

            // Add event listeners for view donations buttons
            document.querySelectorAll('.donate-btn').forEach(button => {
                button.addEventListener('click', showUserDonations);
            });

            // Back button event listener
            backButton.addEventListener('click', function () {
                // Hide donation records and show user data list
                donationRecords.style.display = 'none';
                userDataList.style.display = 'block';
                backButton.style.display = 'none';
            });

            function showUserDonations(event) {
                const username = event.target.dataset.user;
                const user = users.find(user => user.username === username);

                console.log('Selected user:', user);  // Debugging line

                // Hide User Data Section
                userDataList.style.display = 'none';
                backButton.style.display = 'block'; // Show the back button

                // Display Donate Money and Donate Food Records for the specific user
                donationRecords.innerHTML = ''; // Clear previous records
                donationRecords.appendChild(backButton); // Ensure back button is at the top

                if (user.DonateMoney && user.DonateMoney.length > 0) {
                    const moneyHeader = document.createElement('h3');
                    moneyHeader.textContent = 'Money Donations';
                    donationRecords.appendChild(moneyHeader);

                    user.DonateMoney.forEach((donation, index) => {
                        const donationCard = document.createElement('div');
                        donationCard.classList.add('card', 'mb-3');
                        donationCard.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">Donation Amount: ${donation.amount}</h5>
                                <p class="card-text"><strong>Username:</strong> ${user.username}</p>
                                <p class="card-text"><strong>Name:</strong> ${donation.firstName} ${donation.lastName}</p>
                                <p class="card-text"><strong>Email:</strong> ${donation.email}</p>
                                <p class="card-text"><strong>Phone:</strong> ${donation.phone}</p>
                                <p class="card-text"><strong>Message:</strong> ${donation.message}</p>
                                ${donation.companyName ? `<p class="card-text"><strong>Company Name:</strong> ${donation.companyName}</p>` : ''}
                                ${donation.role ? `<p class="card-text"><strong>Role:</strong> ${donation.role}</p>` : ''}
                                <p class="card-text"><strong>Newsletter:</strong> ${donation.newsletter ? 'Yes' : 'No'}</p>
                                ${donation.companyName ? `<p class="card-text"><strong>Receipt:</strong> ${donation.receipt ? 'Yes' : 'No'}</p>` : ''}
                                <button class="btn btn-danger btn-sm delete-btn" data-user="${user.username}" data-index="${index}" data-type="money">Delete</button>
                            </div>
                        `;
                        donationRecords.appendChild(donationCard);
                    });
                } else {
                    const noMoneyDonations = document.createElement('p');
                    noMoneyDonations.textContent = 'No money donations found.';
                    donationRecords.appendChild(noMoneyDonations);
                }

                if (user.DonateFood && user.DonateFood.length > 0) {
                    const foodHeader = document.createElement('h3');
                    foodHeader.textContent = 'Food Donations';
                    donationRecords.appendChild(foodHeader);

                    user.DonateFood.forEach((donation, index) => {
                        const donationCard = document.createElement('div');
                        donationCard.classList.add('card', 'mb-3');
                        donationCard.innerHTML = `
                            <div class="card-body">
                                <p class="card-text"><strong>Username:</strong> ${user.username}</p>
                                <p class="card-text"><strong>Name:</strong> ${donation.firstName} ${donation.lastName}</p>
                                <p class="card-text"><strong>Email:</strong> ${donation.email}</p>
                                <p class="card-text"><strong>Phone:</strong> ${donation.phone}</p>
                                <p class="card-text"><strong>Message:</strong> ${donation.message}</p>
                                <p class="card-text"><strong>Organization:</strong> ${donation.organization}</p>
                                <p class="card-text"><strong>Newsletter:</strong> ${donation.newsletter ? 'Yes' : 'No'}</p>
                                <button class="btn btn-danger btn-sm delete-btn" data-user="${user.username}" data-index="${index}" data-type="food">Delete</button>
                            </div>
                        `;
                        donationRecords.appendChild(donationCard);
                    });
                } else {
                    const noFoodDonations = document.createElement('p');
                    noFoodDonations.textContent = 'No food donations found.';
                    donationRecords.appendChild(noFoodDonations);
                }

                // Add event listeners for delete buttons for donations
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', deleteDonation);
                });

                // Show donation records section
                donationRecords.style.display = 'block';
            }

            function deleteDonation(event) {
                const username = event.target.dataset.user;
                const index = event.target.dataset.index;
                const type = event.target.dataset.type;
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(user => user.username === username);

                if (confirm("Are you sure you want to delete this donation?")) {
                    if (type === 'money') {
                        users[userIndex].DonateMoney.splice(index, 1);
                    } else if (type === 'food') {
                        users[userIndex].DonateFood.splice(index, 1);
                    }
                    localStorage.setItem('users', JSON.stringify(users)); // Update local storage for users

                    // Update currentUser if it matches the deleted user's username
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (currentUser.username === username) {
                        if (type === 'money') {
                            currentUser.DonateMoney = users[userIndex].DonateMoney;
                        } else if (type === 'food') {
                            currentUser.DonateFood = users[userIndex].DonateFood;
                        }
                        localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Update local storage for currentUser
                    }

                    // Remove the donation card from the DOM
                    const donationCard = event.target.closest('.card');
                    donationCard.remove();
                }
            }
        });
    </script>
</body>

</html>